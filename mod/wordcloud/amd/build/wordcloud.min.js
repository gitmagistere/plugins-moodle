function _classCallCheck(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function _createClass(a,b,c){if(b)_defineProperties(a.prototype,b);if(c)_defineProperties(a,c);return a}define ("mod_wordcloud/wordcloud",["jquery","core/str"],function(a,b){var e=[],f=2e3,g=350,h=600,i="",j=d3.scale.category20();function c(b,c,d,f){i=d;e[b]=new k(b,c,a(c).width(),.56*a(c).width(),f)}var k=function(){function c(b,d,e,f,i){_classCallCheck(this,c);this.width=e;this.height=f>h?h:f<g?g:f;this.displaymod;this.cmid=b;this.selector=d;this.parent=a(d).parent();this.editing=i;this.isediting=!1;this.editingword="";this.resizetimer;this.updatetimer;this.updatedelay=2e3;this.lastupdate=0;this.words=[];this.wordsrender=[];this.wcwidth=a(this.selector).parents("#region-main-box").width();this.borderwidth=this.wcwidth-a(this.selector).width();this.currentgroupid=-1;this.svg=d3.select(this.selector).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.width/2+","+this.height/2+")");this.svg;if(0<a("#fitem_id_word_1").length){this.switch_display("f")}else{if(0<this.parent.find(".wc_groupselector").length){this.changegroup(this.parent.find(".wc_groupselector").val())}else{this.changegroup(0)}}this.listeners()}_createClass(c,[{key:"listeners",value:function listeners(){if(this.parent.find(".wc_groupselector").length){this.parent.find(".wc_groupselector").on("change",function(){var a=this.parent.find(".wc_groupselector");this.changegroup(a.val())}.bind(this))}a(window).resize(function(){if("c"==this.displaymod){if(this.resizetimer!=void 0){clearTimeout(this.resizetimer)}this.resizetimer=setTimeout(this.resize.bind(this),500)}}.bind(this));if(this.editing){d3.select(this.selector.split(" ")[0]+" .wc_exportpng").on("click",this.exportPNG.bind(this));this.parent.on("click",".wc_exportdata",function(){this.exportData()}.bind(this));this.parent.on("click",".wc_addword",function(){this.addWord(this)}.bind(this));this.parent.on("keypress","input[name=wcaddword]",function(b){var c=b.which;if(13==c){a(this.parent).find(".wc_addword").click();return!1}}.bind(this));a(this.selector).on("click","svg text",function(b){if(!this.isediting){this.loadWordEdit(a(b.target).text())}}.bind(this));this.parent.on("keypress","input[name=wceditword]",function(b){var c=b.which;if(13==c){a(this.parent).find(".wc_updateword").click();return!1}}.bind(this));a(this.parent).on("click",".wc_updateword",function(){if(this.isediting){this.updateWord()}}.bind(this));a(this.parent).on("click",".wc_removeword",function(){if(this.isediting){this.removeWord();this.closeWordEdit()}}.bind(this));this.parent.on("click",".wc_closeedit",function(){if(this.isediting){this.closeWordEdit()}}.bind(this))}}},{key:"draw",value:function draw(a){var b=this.svg.selectAll("g text").data(a,function(a){return a.text});b.enter().append("text").style("font-family","Impact").style("fill",function(){return j(Math.random())}).attr("text-anchor","middle").attr("font-size",1).text(function(a){return a.text});b.transition().duration(600).style("font-size",function(a){return a.size+"px"}).attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("fill-opacity",1);b.exit().transition().duration(200).style("fill-opacity",1e-6).attr("font-size",1).remove()}},{key:"update_svg",value:function update_svg(){this.wordsrender=JSON.parse(JSON.stringify(this.words));d3.layout.cloud().size([this.width,this.height]).words(this.wordsrender).padding(3).rotate(function(){return 90*~~(2*Math.random())-45}).font("Impact").fontSize(function(a){return a.size}).on("end",this.draw.bind(this)).start()}},{key:"resize",value:function resize(){if(this.wcwidth!=a(this.selector).parents("#region-main-box").width()){this.wcwidth=a(this.selector).parents("#region-main-box").width();this.width=a(this.selector).parents("#region-main-box").width()-this.borderwidth;this.height=.56*this.width;if(this.height>h){this.height=h}else if(this.height<g){this.height=g}a(this.selector).find("svg").attr("width",this.width).attr("height",this.height).find("g").attr("transform","translate("+this.width/2+","+this.height/2+")");this.update_svg()}}},{key:"changegroup",value:function changegroup(a){if(this.currentgroupid!=a){this.currentgroupid=a;this.lastupdate=0;this.words=[];this.wordsrender=[];var b=window.location.protocol+"//"+window.location.host+window.location.pathname+"?id="+this.cmid+"&g="+a;window.history.replaceState({path:b},document.title,b);this.update_wordcloud()}}},{key:"displayaddform",value:function displayaddform(){a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"getaddword",groupid:this.currentgroupid}),dataType:"json",success:function(a){if(!1==a.error){}}.bind(this),error:function error(){}})}},{key:"switch_display",value:function switch_display(b){if(this.displaymod==b){if("c"==b){if(this.editing){a(".wc_tools").show()}else{a(".wc_tools").hide()}}return}if("f"==b){this.displaymod="f";if(a(".wordcloudcontainer").is(":visible")){a(".wordcloudcontainer").hide()}if(this.editing){a(".wc_tools").hide()}if(!a("#wcform").is(":visible")){a("#wcform").show()}}else{this.displaymod="c";if(a("#wcform").is(":visible")){a("#wcform").html("");a("#wcform").hide()}if(!a(".wordcloudcontainer").is(":visible")){a(".wordcloudcontainer").show()}if(this.editing){a(".wc_tools").show()}}}},{key:"update_wordcloud",value:function update_wordcloud(){var c=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;if(!c&&this.isediting){return}if(this.lastupdate==void 0){this.lastupdate=0}a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"getdata",groupid:this.currentgroupid,lastupdate:this.lastupdate}),dataType:"json",success:function(c){var d=this;if(!1==c.error){if("c"==c.mod){if(!0==c.noupdate){this.updatedelay=this.updatedelay+f}else{if(this.parent.find(".wc_participation").length){if(0==c.subs){b.get_string("nosubmition","mod_wordcloud").then(function(a){d.parent.find(".wc_participation_count").text(a)})}else if(1==c.subs){b.get_string("onesubmition","mod_wordcloud",c.subs).then(function(a){d.parent.find(".wc_participation_count").text(a)})}else{b.get_string("multi_submition","mod_wordcloud",c.subs).then(function(a){d.parent.find(".wc_participation_count").text(a)})}}this.updatedelay=f;this.lastupdate=c.timemodified;this.editing=c.editor;this.words=c.words;this.switch_display("c");this.update_svg();if(0==this.words.length){a(".wc_empty").show()}else{a(".wc_empty").hide()}}if(this.updatetimer!=void 0){clearTimeout(this.updatetimer)}if(this.updatedelay<6e4){this.updatetimer=setTimeout(function(){this.update_wordcloud()}.bind(this),this.updatedelay)}}else{this.switch_display("f");a("#wcform").html(c.form)}}}.bind(this),error:function error(){}})}},{key:"exportPNG",value:function exportPNG(){d3.event.preventDefault();var b=document.createElement("canvas"),c=b.getContext("2d");b.width=this.width,b.height=this.height,c.translate(this.width>>1,this.height>>1),this.wordsrender.forEach(function(a){c.save(),c.translate(a.x,a.y),c.rotate(a.rotate*Math.PI/180),c.textAlign="center",c.fillStyle=j(a.text.toLowerCase()),c.font=a.size+"px "+a.font,c.fillText(a.text,0,0),c.restore()});var d=document.createElement("a");d.href=b.toDataURL("image/png").replace("image/png","image/octet-stream");d.download="export.png";d.click()}},{key:"exportData",value:function exportData(){a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"exportdata",groupid:this.currentgroupid}),dataType:"json",success:function(b){if(!1==b.error){var c=document.createElement("a");if(window.URL&&window.Blob&&"download"in c&&window.atob){var a=d(b.data,"text/octet-stream"),e=window.URL.createObjectURL(a);c.href=e;c.download="export.csv";c.click();window.URL.revokeObjectURL(e)}}}.bind(this),error:function error(){}})}},{key:"addWord",value:function addWord(){a(this.parent).find("input[name=\"wcaddword\"]").prop("disabled",!0);a(this.parent).find(".wc_addword").prop("disabled",!0);var b=a(this.parent).find("input[name=\"wcaddword\"]").val();a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"addword",word:b,groupid:this.currentgroupid}),dataType:"json",success:function(b){if(!1==b.error){this.update_wordcloud()}a(this.parent).find("input[name=\"wcaddword\"]").prop("disabled",!1);a(this.parent).find(".wc_addword").prop("disabled",!1);a(this.parent).find("input[name=\"wcaddword\"]").val("");a(this.parent).find("input[name=\"wcaddword\"]").focus()}.bind(this),error:function(){a(this.parent).find("input[name=\"wcaddword\"]").prop("disabled",!1);a(this.parent).find(".wc_addword").prop("disabled",!1);a(this.parent).find("input[name=\"wcaddword\"]").val("");a(this.parent).find("input[name=\"wcaddword\"]").focus()}.bind(this)})}},{key:"loadWordEdit",value:function loadWordEdit(b){this.isediting=!0;this.editingword=b;a(this.selector).addClass("locked");this.parent.find(".wc_groupselector").prop("disabled",!0);a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"getwordinfo",word:b,groupid:this.currentgroupid}),dataType:"json",success:function(b){if(!1==b.error){this.parent.find("input[name=wceditword]").val(b.word);this.parent.find(".wc_weight span").text(b.weight);var c=this.parent.find(".wc_users ul");c.html("");a(b.users).each(function(a,b){c.append("<li>"+b+"</li>")});this.parent.find(".wc_tools").slideUp(500);this.parent.find(".wc_editor_word").slideDown(500)}}.bind(this),error:function error(){}})}},{key:"closeWordEdit",value:function closeWordEdit(){this.isediting=!1;this.editingword="";this.parent.find("input[name=wceditword]").val("");this.parent.find(".wc_weight span").text("");var b=this.parent.find(".wc_users ul");b.html("");this.parent.find(".wc_tools").slideDown(500);this.parent.find(".wc_editor_word").slideUp(500);a(this.selector).removeClass("locked");this.parent.find(".wc_groupselector").prop("disabled",!1)}},{key:"updateWord",value:function updateWord(){var b=this.parent.find("input[name=wceditword]").val();a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"updateword",word:this.editingword,newword:b,groupid:this.currentgroupid}),dataType:"json",success:function(a){if(!1==a.error){this.lastupdate=0;this.update_wordcloud(!0);this.loadWordEdit(b)}}.bind(this),error:function error(){}})}},{key:"removeWord",value:function removeWord(){a.ajax({type:"POST",url:i,data:JSON.stringify({cmid:this.cmid,action:"removeword",word:this.editingword,groupid:this.currentgroupid}),dataType:"json",success:function(a){if(!1==a.error){this.lastupdate=0;this.update_wordcloud()}}.bind(this),error:function error(){}})}}]);return c}();function d(a,b,c){if(!window.atob||!window.Uint8Array){return null}b=b||"";c=c||512;for(var d=atob(a),e=[],f=0;f<d.length;f+=c){for(var g=d.slice(f,f+c),h=Array(g.length),j=0;j<g.length;j++){h[j]=g.charCodeAt(j)}var k=new Uint8Array(h);e[e.length]=k}return new Blob(e,{type:b})}return{showWordcloud:function showWordcloud(a,b,d,e){c(a,b,d,e)}}});
//# sourceMappingURL=wordcloud.min.js.map
