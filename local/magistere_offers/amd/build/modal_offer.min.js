define(["jquery","core/templates","core/ajax","jqueryui","local_magistere_offers/jquery.loadingModal"],function(a,b,c){return{init:function(){function d(b,c){a(b).off("click"),a("#region-main").on("click",c,function(c){a(b).hasClass("in")?(a(this).addClass("collapsed"),a(b).removeClass("in")):(a(this).removeClass("collapsed"),a(b).addClass("in"))})}function e(){a("#restore_course_form").submit()}function f(a){return'<div>   <p>La restauration du parcours a bien été effectué</p>   <div class="after-restore-links">       <a class="btn restore-course-view" href="'+a+'">Accéder au parcours restauré</a>       <a class="btn restore-course-close-modal" href="#">Retour sur l\'offre de parcours</a>   </div></div>'}function g(a){return"<div>   <p>La restauration du parcours a échouée ("+a+')</p>   <div class="after-restore-links">       <a class="btn restore-course-close-modal" href="#">Retour sur l\'offre de parcours</a>   </div></div>'}function h(b){a(b+' input[name="fullname"]').val(""),a(b+' input[name="shortname"]').val(""),a(b+' select[name*="categoryid"]').val(a(b+' select[name="categoryid"] option').first().val())}function i(b){var c=a("#detailModal #modalOfferTitle").text(),d=a("#detailModal .hidden .shortname").text();a(b+' input[name="fullname"]').val(c),a(b+' input[name="shortname"]').val(d)}var j=!1;a(document).ready(function(){if(window.location.hash){j=!0;var e=window.location.href;e=e.indexOf("?")==-1?e.replace("#","?"):e.replace("#","&");var f=new URL(e),g=f.searchParams.get("offer"),k="#modalOffer_"+g,l=c.call([{methodname:"local_magistere_offers_get_detail_offer",args:{id:g}}]);l[0].done(function(c){obj=JSON.parse(c);var d="local_magistere_offers/modal_formation_offer";obj.is_formation===!1&&(d="local_magistere_offers/modal_course_offer",a("#restore_course_form").find('input[name="hubcourseid"]').val(g)),b.render(d,obj).then(function(b,c){a("#detailModal").html(b),a(k).modal("show"),a("#detailModal .modal").on("shown.bs.modal",function(){a("body").addClass("modal-open")}),a("#detailModal .modal").on("hidden.bs.modal",function(){history.pushState("",document.title,window.location.pathname+window.location.search),a("body").removeClass("modal-open"),j=!1}),a("<script>").append(c).appendTo("body"),a("#detailModal").on("click",".restore.link.course",function(b){h("#dialog_restore_course"),i("#dialog_restore_course"),a("#dialog_restore_course").show(),a(".modal-backdrop").css("z-index",1050),a("#dialog_restore_course").dialog("open")}),a(".ui-button-icon.ui-icon-closethick").click(function(b){a(".modal-backdrop").css("z-index",1040),h("#dialog_restore_course")})})}).fail(function(a){console.log(a),j=!1})}d(".notes .itemelement",".notes .itemtitle"),d(".statistics .itemelement",".statistics .itemtitle"),a.fn.modal.Constructor.prototype.enforceFocus=function(){}}),a("#region-main").on("click",'a[ref-bs-element="modal"]',function(){if(!j){j=!0;var d=a(this).attr("ref-modal-id"),e="#"+a(this).attr("ref-modal"),f=c.call([{methodname:"local_magistere_offers_get_detail_offer",args:{id:d}}]);f[0].done(function(c){obj=JSON.parse(c);var f="local_magistere_offers/modal_formation_offer";obj.is_formation===!1&&(f="local_magistere_offers/modal_course_offer",a("#restore_course_form").find('input[name="hubcourseid"]').val(d)),b.render(f,obj).then(function(b,c){a("#detailModal").html(b),a(e).modal("show"),a("#detailModal .modal").on("shown.bs.modal",function(){a("body").addClass("modal-open")}),a("#detailModal .modal").on("hidden.bs.modal",function(){history.pushState("",document.title,window.location.pathname+window.location.search),a("body").removeClass("modal-open")}),a("<script>").append(c).appendTo("body"),a("#detailModal").on("click",".restore.link.course",function(b){h("#dialog_restore_course"),i("#dialog_restore_course"),a("#dialog_restore_course").show(),a(".modal-backdrop").css("z-index",1050),a("#dialog_restore_course").dialog("open")}),a(".ui-button-icon.ui-icon-closethick").click(function(b){a(".modal-backdrop").css("z-index",1040),h("#dialog_restore_course")}),j=!1})}).fail(function(a){console.log(a),j=!1})}}),a("#dialog_restore_course").dialog({autoOpen:!1,width:600,height:350,title:"Restaurer un parcours de formation",draggable:"false",modal:!0,resizable:!1,closeOnEscape:!1,closeText:"Fermer",buttons:[{text:"Restaurer ",id:"btRestoreCours",click:function(){""==a('#dialog_restore_course input[name="fullname"]').val()?alert("Le nom est obligatoire"):""==a('#dialog_restore_course input[name="shortname"]').val()?alert("Le nom abrégé est obligatoire"):e()}},{text:"Annuler",id:"btAnnuler",click:function(){h("#dialog_restore_course"),a(this).dialog("close"),a(".modal-backdrop").css("z-index",1040)}}]}),a(document).on("submit","#restore_course_form",function(b){b.preventDefault();var c=a(this),d=c.find('input[name="fullname"]').val(),e=c.find('input[name="shortname"]').val(),i=c.attr("action");""!=d&&""!=e&&(a("body").loadingModal({position:"auto",text:"Restauration du parcours en cours",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"}),a.ajax({type:"POST",url:i,data:a("#restore_course_form").serialize(),dataType:"json",success:function(b){if(0==b.error){var c=b.newid,d=i.search("/local/coursehub/restore.php"),e=i.split(i.substr(d))[0],j=e+"/course/view.php?id="+c;a("body").loadingModal("text",f(j)),a("body").loadingModal("animation","doubleBounce"),h("#dialog_restore_course"),a("#dialog_restore_course").dialog("close"),a(".modal-backdrop").css("z-index",1040)}else a("body").loadingModal("text",g(b.msg));a(".after-restore-links a").click(function(b){a("body").loadingModal("hide"),setTimeout(function(){a("body").loadingModal("destroy")},1e3)})},error:function(b){a("body").loadingModal("text",g("Unknown error")),console.log(b)}}))})}}});